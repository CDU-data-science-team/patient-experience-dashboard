---
title: My Document
output: html_document
params:
  division: NA
  directorate: NA
  team: NA
  date_from: NA
  date_to: NA
---

<!-- So I need to declare the parameters here, and then pass them through from Shiny -->
<!-- Then I can use an observe() function with the GET string so the report is generated if -->
<!-- The parameters are set using a GET string -->


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

suceData = trustData %>%
  filter(Division %in% params$division)

if(is.null(suceData)){
  
  report_information = NULL
  
} else {
  
  # FFT score
  
  promoterScores = suceData[, "Promoter2"]
  
  if(length(promoterScores[!is.na(promoterScores)]) > 0) {
    
    FFT = round(sum(promoterScores %in% 4:5, na.rm = TRUE) /
                  sum(promoterScores %in% 0:5, na.rm = TRUE) * 100, 0)
    
  }
  
  # Quality score
  
  SQ = round(mean(suceData[, "Service"], na.rm = TRUE) * 20, 0)
  
  # Number of responses
  
  NR = nrow(suceData)
  
  NSQ = length(suceData$Service[!is.na(suceData$Service)])
  
  NFFT = length(suceData$Promoter2[!is.na(suceData$Promoter2)])
  
  # number of comments
  
  IC = length(suceData[, "Improve"][!is.na(suceData[, "Improve"])])
  BC = length(suceData[, "Best"][!is.na(suceData[, "Best"])])
  
  # were you aware of how to raise a concern yes/ no/ maybe
  
  complaint_numbers <- map_int(c("D", "N", "Y"), function(x){
    
    suceData %>%
      filter(Complaint == x) %>%
      nrow()
  })
  
  # criticality
  
  improve_numbers <- map_int(c(1, 2, 3), function(x){
    
    suceData %>%
      filter(ImpCrit == x) %>%
      nrow()
  })
  
  # criticality
  
  best_numbers <- map_int(c(1, 2, 3), function(x){
    
    suceData %>%
      filter(BestCrit == x) %>%
      nrow()
  })
  
  # name of the area
  
  # this bit doesn't work
  
  # if(is.null(input$selTeam)){
  #   
  #   theArea = "the selected area"
  #   
  # } else {
  #   
  #   ### look up team names
  #   
  #   teams <- as.tibble(input$selTeam) %>%
  #     inner_join(
  #       counts %>%
  #         group_by(TeamC) %>%
  #         slice(which.max(as.Date(date_from)))
  #     )
  #   
  #   team_names <- teams %>% pull(TeamN)
  #   
  # }
  
  theArea = "the selected area"
  
  report_information <- 
    list("theArea" = theArea, "NR" = NR, "IC" = IC, "BC" = BC, "NFFT" = NFFT,
         "FFT" = FFT, "NSQ" = NSQ, "SQ" = SQ, "complaint_numbers" = complaint_numbers,
         "improve_numbers" = improve_numbers, "best_numbers" = best_numbers)
}


```

## Context

```{r}

# what I need more than anything here is a list of the other report areas so I can link 

# fetch the state of the teams

```

## Summary

```{r, results = "asis"}

if(is.null(report_information)){

  myString = "Within the selected time and area there were no responses"
} else {

  myString = paste0("<p>Within ", report_information[["theArea"]], " in the selected time there were ", report_information[["NR"]],
                    " responses.</p><br>",
                    "<p>There were ", report_information[["IC"]], " 'What could we do better' responses and ", report_information[["BC"]],
                    " 'What did we do well' responses</p><br>",
                    ifelse(report_information[["NFFT"]] > 9,
                           paste0("<p>The Friends and Family Test Score is the proportion of patients
      who are extremely likely or likely to recommend a service. In the selected period of time it was ",
                                  report_information[["FFT"]], "% (based on ", report_information[["NFFT"]], " responses.)", "</p><br>"), ""),
                    ifelse(report_information[["NSQ"]] > 9,
                           paste0("<p>Service quality rating was ", report_information[["SQ"]], "% (based on ", report_information[["NSQ"]],
                                  " responses.)</p>"), ""),
                    ifelse(sum(report_information[["complaint_numbers"]]) > 3,
                           paste0("<p>", report_information[["complaint_numbers"]][3], " individuals reported that they knew how to make a complaint, ",
                                  report_information[["complaint_numbers"]][2], " reported that they did not know how to make a complaint, and ",
                                  report_information[["complaint_numbers"]][1], " reported that they were unsure if they knew.</p>"), "")
  )
}

cat(myString)

```